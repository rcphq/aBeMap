<!DOCTYPE html>
<html>
<head>
    <title>LeafletJS Map with Save and Autocomplete</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- LeafletJS CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <!-- jQuery UI CSS for autocomplete -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

    <style>
        #map {
            height: 70vh; /* Map takes 70% of the viewport height */
            margin: 0;
        }

        #locationForm {
            padding: 10px;
            background-color: #f9f9f9;
            border-bottom: 1px solid #ccc;
        }

        #locationForm input, #locationForm button {
            padding: 5px;
            margin: 5px;
        }

        #fileInput {
            display: inline-block;
        }
    </style>
</head>
<body>
    <!-- Form for user input -->
    <div id="locationForm">
        <input type="text" id="personName" placeholder="Enter person name (e.g., 'John Doe')" required>
        <input type="text" id="friendlyName" placeholder="Enter location name (e.g., 'Berlin')" required>
        <button onclick="addLocation()">Add Location</button>
        <button onclick="saveLocations()">Save to Local Storage</button>
        <button onclick="loadLocations()">Load from Local Storage</button>
        <button onclick="exportLocations()">Export Locations</button>
        <input type="file" id="fileInput" accept=".csv" onchange="importLocations(event)">
    </div>

    <!-- Map container -->
    <div id="map"></div>

    <!-- LeafletJS JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- jQuery and jQuery UI for autocomplete -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <script>
        // Initialize the map
        var map = L.map('map').setView([48.0, 10.0], 4); // Centered in Europe

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Create a MarkerClusterGroup
        var markers = L.markerClusterGroup();
        map.addLayer(markers);

        // Array to store location data
        var locationsData = [];

        // Prefilled list of cities for autocomplete
        var cityList = [
            "Berlin", "Paris", "London", "New York", "Tokyo", "Beijing", "Sydney", "Moscow", "Dubai", "Los Angeles",
            "Mumbai", "Cairo", "São Paulo", "Istanbul", "Mexico City", "Johannesburg", "Bangkok", "Rome", "Toronto",
            "Singapore"
        ];

        // jQuery Autocomplete for location name input
        $(function () {
            $("#friendlyName").autocomplete({
                source: cityList
            });
        });

        // Function to fetch coordinates from Nominatim API
        async function geocodeLocation(locationName) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}`;

            try {
                const response = await fetch(url);
                const results = await response.json();

                if (results.length > 0) {
                    const { lat, lon, display_name } = results[0];
                    return { lat: parseFloat(lat), lon: parseFloat(lon), name: display_name };
                } else {
                    throw new Error("Location not found");
                }
            } catch (error) {
                console.error("Geocoding error:", error);
                alert("Location not found. Please try a different name.");
            }
        }

        // Function to add a marker to the map
        function addMarker(lat, lon, personName, locationName) {
            const popupContent = `<b>${locationName}</b><br>Person: ${personName}`;
            const marker = L.marker([lat, lon])
                .bindPopup(popupContent)
                .addTo(markers);
            map.setView([lat, lon], 10); // Center map on the new marker
        }

        // Function to handle user input and add location
        async function addLocation() {
            const personName = document.getElementById('personName').value.trim();
            const locationName = document.getElementById('friendlyName').value.trim();

            if (!personName || !locationName) {
                alert("Please fill in both fields.");
                return;
            }

            const location = await geocodeLocation(locationName);
            if (location) {
                addMarker(location.lat, location.lon, personName, location.name);

                // Store the data for future use
                locationsData.push({
                    person: personName,
                    location: location.name,
                    lat: location.lat,
                    lon: location.lon
                });

                // Clear the input fields after adding the location
                document.getElementById('personName').value = '';
                document.getElementById('friendlyName').value = '';
            }
        }

        // Function to save locations to local storage
        function saveLocations() {
            localStorage.setItem('locationsData', JSON.stringify(locationsData));
            alert("Locations saved to local storage!");
        }

        // Function to load locations from local storage
        function loadLocations() {
            const savedData = localStorage.getItem('locationsData');
            if (savedData) {
                locationsData = JSON.parse(savedData);
                locationsData.forEach(loc => {
                    addMarker(loc.lat, loc.lon, loc.person, loc.location);
                });
                alert("Locations loaded from local storage!");
            } else {
                alert("No saved locations found in local storage.");
            }
        }

        // Function to export location data as CSV
        function exportLocations() {
            if (locationsData.length === 0) {
                alert("No locations to export.");
                return;
            }

            // Create CSV content
            let csvContent = "data:text/csv;charset=utf-8,Person,Location,Latitude,Longitude\n";
            locationsData.forEach(loc => {
                csvContent += `${loc.person},${loc.location},${loc.lat},${loc.lon}\n`;
            });

            // Create a download link and trigger the download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "locations.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Function to import locations from a CSV file
        function importLocations(event) {
            const file = event.target.files[0];
            if (!file) {
                alert("No file selected.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const content = e.target.result;
                const rows = content.split("\n").slice(1); // Skip header row

                rows.forEach(row => {
                    const [person, location, lat, lon] = row.split(",").map(value => value.trim());
                    if (person && location && lat && lon) {
                        addMarker(parseFloat(lat), parseFloat(lon), person, location);

                        // Store the imported data for future exports
                        locationsData.push({
                            person,
                            location,
                            lat: parseFloat(lat),
                            lon: parseFloat(lon)
                        });
                    }
                });

                alert("Locations imported successfully!");
            };

            reader.onerror = function () {
                alert("Failed to read file. Please try again.");
            };

            reader.readAsText(file);
        }
    </script>
</body>
</html>
